<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§Ÿå®¢ä¿¡æ¯ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        .login-container {
            background-color: white;
            padding: 2rem;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        form {
            display: flex;
            flex-direction: column;
        }
        input {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        
        /* æ·»åŠ æ–°æ ·å¼ */
        .dashboard {
            display: none;
            padding: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        #tenantForm {
            display: none;
            margin-top: 20px;
        }
        .form-group {
            margin-bottom: 10px;
        }
        .form-group label {
            display: inline-block;
            width: 100px;
            text-align: right;
            margin-right: 10px;
        }
        .password-container {
            position: relative;
        }
        .toggle-password {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
        }
        .error-message {
            color: red;
            font-size: 0.8em;
            margin-top: 5px;
        }
        #exportBtn {
            margin-left: 10px;
        }
    </style>
    <!-- æ·»åŠ  SheetJS åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
</head>
<body>
    <div class="login-container">
        <h1>ç§Ÿå®¢ä¿¡æ¯ç®¡ç†ç³»ç»Ÿ</h1>
        <form id="loginForm">
            <input type="text" id="username" placeholder="ç”¨æˆ·å" required>
            <div class="password-container">
                <input type="password" id="password" placeholder="å¯†ç " required>
                <span class="toggle-password" onclick="togglePassword()">ğŸ‘ï¸</span>
            </div>
            <button type="submit">ç™»å½•</button>
        </form>
        <p id="message"></p>
        <p>è¿˜æ²¡æœ‰è´¦å·? <a href="#" id="registerLink">æ³¨å†Œ</a></p>
    </div>

    <div id="registerForm" style="display: none;">
        <h2>æ³¨å†Œæ–°ç”¨æˆ·</h2>
        <form id="newUserForm">
            <input type="text" id="newUsername" placeholder="ç”¨æˆ·å" required>
            <input type="password" id="newPassword" placeholder="å¯†ç " required>
            <input type="password" id="confirmPassword" placeholder="ç¡®è®¤å¯†ç " required>
            <button type="submit">æ³¨å†Œ</button>
        </form>
        <p id="registerMessage"></p>
        <p>å·²æœ‰è´¦å·? <a href="#" id="loginLink">ç™»å½•</a></p>
    </div>

    <div id="dashboard" class="dashboard">
        <h1>ç§Ÿå®¢ä¿¡æ¯ç®¡ç†ç³»ç»Ÿ - ä»ªè¡¨æ¿</h1>
        <h2>ç§Ÿå®¢åˆ—è¡¨</h2>
        <table>
            <thead>
                <tr>
                    <th>åºå·</th>
                    <th>å§“å</th>
                    <th>å¹´é¾„</th>
                    <th>æ€§åˆ«</th>
                    <th>èº«ä»½è¯å·ç </th>
                    <th>è”ç³»å·ç </th>
                    <th>æˆ·ç±åœ°å€</th>
                    <th>æˆ¿é—´å·</th>
                    <th>å…¥ä½å¤©æ•°</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="tenantList">
                <!-- ç§Ÿå®¢æ•°æ®å°†é€šè¿‡ JavaScript åŠ¨æ€æ·»åŠ  -->
            </tbody>
        </table>
        <button id="addTenantBtn">æ·»åŠ æ–°ç§Ÿå®¢</button>
        <button id="exportBtn">å¯¼å‡ºç§Ÿå®¢åˆ—è¡¨</button>

        <div id="tenantForm">
            <h3 id="formTitle">æ·»åŠ æ–°ç§Ÿå®¢</h3>
            <form id="tenantInfoForm">
                <input type="hidden" id="tenantId">
                <div class="form-group">
                    <label for="name">å§“å:</label>
                    <input type="text" id="name" required>
                </div>
                <div class="form-group">
                    <label for="age">å¹´é¾„:</label>
                    <input type="number" id="age" required readonly>
                </div>
                <div class="form-group">
                    <label for="gender">æ€§åˆ«:</label>
                    <select id="gender" required readonly>
                        <option value="">é€‰æ‹©æ€§åˆ«</option>
                        <option value="ç”·">ç”·</option>
                        <option value="å¥³">å¥³</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="idCard">èº«ä»½è¯å·ç :</label>
                    <input type="text" id="idCard" required>
                    <p class="error-message" id="idCardError"></p>
                </div>
                <div class="form-group">
                    <label for="phone">è”ç³»å·ç :</label>
                    <input type="tel" id="phone" required>
                    <p class="error-message" id="phoneError"></p>
                </div>
                <div class="form-group">
                    <label for="address">æˆ·ç±åœ°å€:</label>
                    <input type="text" id="address" required>
                </div>
                <div class="form-group">
                    <label for="room">æˆ¿é—´å·:</label>
                    <input type="text" id="room" required>
                </div>
                <div class="form-group">
                    <label for="checkInDate">å…¥ä½æ—¥æœŸ:</label>
                    <input type="date" id="checkInDate" required>
                </div>
                <button type="submit">ä¿å­˜</button>
                <button type="button" id="cancelBtn">å–æ¶ˆ</button>
            </form>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–ç§Ÿå®¢æ•°æ®
        let tenants = [];
        let currentUser = '';

        // ä¿®æ”¹ç™»å½•é€»è¾‘
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            var username = document.getElementById('username').value;
            var password = document.getElementById('password').value;
            
            // è¿™é‡Œåº”è¯¥å‘é€åˆ°åç«¯è¿›è¡ŒéªŒè¯
            if (localStorage.getItem(username) === password) {
                currentUser = username;
                document.getElementById('message').textContent = 'ç™»å½•æˆåŠŸï¼';
                document.querySelector('.login-container').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                loadTenants();
            } else {
                document.getElementById('message').textContent = 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚';
            }
        });

        // ä¿®æ”¹ç§Ÿå®¢æ•°æ®åŠ è½½å’Œä¿å­˜å‡½æ•°
        function loadTenants() {
            tenants = JSON.parse(localStorage.getItem(currentUser + '_tenants')) || [];
            const tenantList = document.getElementById('tenantList');
            tenantList.innerHTML = '';
            tenants.forEach((tenant, index) => {
                const daysStayed = calculateDaysStayed(tenant.checkInDate);
                const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${tenant.name}</td>
                        <td>${tenant.age}</td>
                        <td>${tenant.gender}</td>
                        <td>${tenant.idCard}</td>
                        <td>${tenant.phone}</td>
                        <td>${tenant.address}</td>
                        <td>${tenant.room}</td>
                        <td>${daysStayed}</td>
                        <td class="action-buttons">
                            <button onclick="editTenant(${tenant.id})">ç¼–è¾‘</button>
                            <button onclick="deleteTenant(${tenant.id})">åˆ é™¤</button>
                        </td>
                    </tr>
                `;
                tenantList.innerHTML += row;
            });
        }

        function saveTenants() {
            localStorage.setItem(currentUser + '_tenants', JSON.stringify(tenants));
        }

        // ä¿å­˜ç§Ÿå®¢ä¿¡æ¯
        document.getElementById('tenantInfoForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const idCard = document.getElementById('idCard').value;
            const phone = document.getElementById('phone').value;
            let isValid = true;

            if (!validateIdCard(idCard)) {
                document.getElementById('idCardError').textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„èº«ä»½è¯å·ç ';
                isValid = false;
            } else {
                document.getElementById('idCardError').textContent = '';
                const info = getInfoFromIdCard(idCard);
                if (info) {
                    document.getElementById('age').value = info.age;
                    document.getElementById('gender').value = info.gender;
                }
            }

            if (!validatePhone(phone)) {
                document.getElementById('phoneError').textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ‰‹æœºå·ç ';
                isValid = false;
            } else {
                document.getElementById('phoneError').textContent = '';
            }

            if (!isValid) return;

            const tenantId = document.getElementById('tenantId').value;
            const tenant = {
                id: tenantId ? parseInt(tenantId) : Date.now(),
                name: document.getElementById('name').value,
                age: parseInt(document.getElementById('age').value),
                gender: document.getElementById('gender').value,
                idCard: idCard,
                phone: phone,
                address: document.getElementById('address').value,
                room: document.getElementById('room').value,
                checkInDate: document.getElementById('checkInDate').value
            };

            if (tenantId) {
                // æ›´æ–°ç°æœ‰ç§Ÿå®¢
                const index = tenants.findIndex(t => t.id === parseInt(tenantId));
                tenants[index] = tenant;
            } else {
                // æ·»åŠ æ–°ç§Ÿå®¢
                tenants.push(tenant);
            }

            saveTenants(); // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            loadTenants();
            document.getElementById('tenantForm').style.display = 'none';
        });

        // ç¼–è¾‘ç§Ÿå®¢ä¿¡æ¯
        function editTenant(id) {
            const tenant = tenants.find(t => t.id === id);
            if (tenant) {
                document.getElementById('formTitle').textContent = 'ç¼–è¾‘ç§Ÿå®¢ä¿¡æ¯';
                document.getElementById('tenantId').value = tenant.id;
                document.getElementById('name').value = tenant.name;
                document.getElementById('idCard').value = tenant.idCard;
                const info = getInfoFromIdCard(tenant.idCard);
                if (info) {
                    document.getElementById('age').value = info.age;
                    document.getElementById('gender').value = info.gender;
                } else {
                    document.getElementById('age').value = tenant.age;
                    document.getElementById('gender').value = tenant.gender;
                }
                document.getElementById('phone').value = tenant.phone;
                document.getElementById('address').value = tenant.address;
                document.getElementById('room').value = tenant.room;
                document.getElementById('checkInDate').value = tenant.checkInDate;
                document.getElementById('tenantForm').style.display = 'block';
            }
        }

        // åˆ é™¤ç§Ÿå®¢ä¿¡æ¯
        function deleteTenant(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç§Ÿå®¢å—ï¼Ÿ')) {
                tenants = tenants.filter(t => t.id !== id);
                saveTenants(); // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                loadTenants();
            }
        }

        // å¯†ç å¯è§åˆ‡æ¢åŠŸèƒ½
        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const toggleButton = document.querySelector('.toggle-password');
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleButton.textContent = 'ğŸ™ˆ';
            } else {
                passwordInput.type = 'password';
                toggleButton.textContent = 'ğŸ‘ï¸';
            }
        }

        // èº«ä»½è¯å·ç éªŒè¯
        function validateIdCard(idCard) {
            const regex = /(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/;
            return regex.test(idCard);
        }

        // æ‰‹æœºå·ç éªŒè¯
        function validatePhone(phone) {
            const regex = /^1[3-9]\d{9}$/;
            return regex.test(phone);
        }

        // è®¡ç®—å…¥ä½å¤©æ•°
        function calculateDaysStayed(checkInDate) {
            const today = new Date();
            const checkIn = new Date(checkInDate);
            const timeDiff = today.getTime() - checkIn.getTime();
            return Math.ceil(timeDiff / (1000 * 3600 * 24));
        }

        // æ ¹æ®èº«ä»½è¯å·ç è·å–æ€§åˆ«å’Œå¹´é¾„
        function getInfoFromIdCard(idCard) {
            if (!validateIdCard(idCard)) {
                return null;
            }

            const birthday = idCard.substr(6, 8);
            const year = parseInt(birthday.substr(0, 4));
            const month = parseInt(birthday.substr(4, 2));
            const day = parseInt(birthday.substr(6, 2));

            const today = new Date();
            let age = today.getFullYear() - year;
            if (today.getMonth() < month - 1 || (today.getMonth() === month - 1 && today.getDate() < day)) {
                age--;
            }

            const genderCode = parseInt(idCard.charAt(16));
            const gender = genderCode % 2 === 0 ? 'å¥³' : 'ç”·';

            return { age, gender };
        }

        // èº«ä»½è¯å·ç è¾“å…¥äº‹ä»¶
        document.getElementById('idCard').addEventListener('input', function() {
            const idCard = this.value;
            const info = getInfoFromIdCard(idCard);
            if (info) {
                document.getElementById('age').value = info.age;
                document.getElementById('gender').value = info.gender;
            }
        });

        // æ·»åŠ æ³¨å†ŒåŠŸèƒ½
        document.getElementById('newUserForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            var username = document.getElementById('newUsername').value;
            var password = document.getElementById('newPassword').value;
            var confirmPassword = document.getElementById('confirmPassword').value;
            
            if (password !== confirmPassword) {
                document.getElementById('registerMessage').textContent = 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´';
                return;
            }
            
            if (localStorage.getItem(username)) {
                document.getElementById('registerMessage').textContent = 'ç”¨æˆ·åå·²å­˜åœ¨';
                return;
            }
            
            localStorage.setItem(username, password);
            localStorage.setItem(username + '_tenants', '[]');
            document.getElementById('registerMessage').textContent = 'æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•';
            showLoginForm();
        });

        // æ˜¾ç¤ºæ³¨å†Œè¡¨å•
        document.getElementById('registerLink').addEventListener('click', function(e) {
            e.preventDefault();
            document.querySelector('.login-container').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
        });

        // æ˜¾ç¤ºç™»å½•è¡¨å•
        document.getElementById('loginLink').addEventListener('click', showLoginForm);

        function showLoginForm() {
            document.querySelector('.login-container').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
        }

        // æ·»åŠ æ–°ç§Ÿå®¢æŒ‰é’®äº‹ä»¶
        document.getElementById('addTenantBtn').addEventListener('click', function() {
            document.getElementById('formTitle').textContent = 'æ·»åŠ æ–°ç§Ÿå®¢';
            document.getElementById('tenantInfoForm').reset();
            document.getElementById('tenantId').value = '';
            document.getElementById('tenantForm').style.display = 'block';
        });

        // å–æ¶ˆæŒ‰é’®äº‹ä»¶
        document.getElementById('cancelBtn').addEventListener('click', function() {
            document.getElementById('tenantForm').style.display = 'none';
        });

        // æ·»åŠ å¯¼å‡ºç§Ÿå®¢åˆ—è¡¨åŠŸèƒ½
        document.getElementById('exportBtn').addEventListener('click', function() {
            // åˆ›å»ºå·¥ä½œç°¿
            const wb = XLSX.utils.book_new();
            
            // å‡†å¤‡æ•°æ®
            const data = [
                ['åºå·', 'å§“å', 'å¹´é¾„', 'æ€§åˆ«', 'èº«ä»½è¯å·ç ', 'è”ç³»å·ç ', 'æˆ·ç±åœ°å€', 'æˆ¿é—´å·', 'å…¥ä½å¤©æ•°']
            ];
            
            tenants.forEach((tenant, index) => {
                const daysStayed = calculateDaysStayed(tenant.checkInDate);
                data.push([
                    index + 1,
                    tenant.name,
                    tenant.age,
                    tenant.gender,
                    tenant.idCard,
                    tenant.phone,
                    tenant.address,
                    tenant.room,
                    daysStayed
                ]);
            });
            
            // åˆ›å»ºå·¥ä½œè¡¨
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // å°†å·¥ä½œè¡¨æ·»åŠ åˆ°å·¥ä½œç°¿
            XLSX.utils.book_append_sheet(wb, ws, "ç§Ÿå®¢åˆ—è¡¨");
            
            // ç”Ÿæˆ Excel æ–‡ä»¶å¹¶ä¸‹è½½
            XLSX.writeFile(wb, "ç§Ÿå®¢åˆ—è¡¨.xlsx");
        });
    </script>
</body>
</html>